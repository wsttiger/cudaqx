name: QEC lib

on:
  workflow_call:

jobs:
  pr-build:
    name: Build and test
    if: startsWith(github.ref, 'refs/heads/pull-request/')
    strategy:
      fail-fast: false
      matrix:
        platform: ['amd64', 'arm64']
        cuda_version: ['12.6', '13.0']
    runs-on: ${{ startsWith(github.repository, 'NVIDIA/cudaqx') && format('linux-{0}-cpu8', matrix.platform) || 'ubuntu-latest' }}
    container: ghcr.io/nvidia/cuda-quantum-devcontainer:${{ matrix.platform }}-cu${{ matrix.cuda_version }}-gcc11-main
    permissions:
      actions: write
      contents: write # REVERT-WITH-CUDAQ-REALTIME-BUILD change back to read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          set-safe-directory: true

      - name: Lookup PR info
        id: get-pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        uses: nv-gha-runners/get-pr-info@main

      - name: Export PR info
        id: export-pr-info
        run: |
          echo "pr_number=${{ fromJSON(steps.get-pr-info.outputs.pr-info).number }}" >> $GITHUB_OUTPUT

      - name: Configure
        id: config
        run: |
          cuda_major=`echo ${{ matrix.cuda_version }} | cut -d . -f1`
          echo "cuda_major=$cuda_major" >> $GITHUB_OUTPUT

      # ========================================================================
      # CUDA Quantum build
      # ========================================================================

      - name: Get required CUDAQ version
        id: get-cudaq-version
        uses: ./.github/actions/get-cudaq-version

      - name: Get CUDAQ build
        uses: ./.github/actions/get-cudaq-build
        with:
          repo: ${{ steps.get-cudaq-version.outputs.repo }}
          ref: ${{ steps.get-cudaq-version.outputs.ref }}
          token: ${{ secrets.CUDAQ_ACCESS_TOKEN }}
          pr-number: ${{ steps.export-pr-info.outputs.pr_number }}
          platform: ${{ matrix.platform }}-cu${{ steps.config.outputs.cuda_major }}

      # ========================================================================
      # Build library
      # ========================================================================
      - name: Install build requirements
        run: |
          apt install -y --no-install-recommends gfortran libblas-dev wget

      - name: Install TensorRT (amd64)
        if: matrix.platform == 'amd64'
        run: |
          apt-cache search tensorrt | awk '{print "Package: "$1"\nPin: version *+cuda${{ matrix.cuda_version }}\nPin-Priority: 1001\n"}' | tee /etc/apt/preferences.d/tensorrt-cuda${{ matrix.cuda_version }}.pref > /dev/null
          apt update
          apt install -y tensorrt-dev

      - name: Install TensorRT (arm64)
        if: matrix.platform == 'arm64' && !startsWith(matrix.cuda_version, '12')
        run: |
          apt-cache search tensorrt | awk '{print "Package: "$1"\nPin: version *+cuda13.0\nPin-Priority: 1001\n"}' | tee /etc/apt/preferences.d/tensorrt-cuda13.0.pref > /dev/null
          apt update
          apt install -y tensorrt-dev

      - name: Build
        id: build
        uses: ./.github/actions/build-lib
        with:
          lib: "qec"
          cuda_version: ${{ matrix.cuda_version }}
          pr-number: ${{ steps.export-pr-info.outputs.pr_number }}
          save-ccache: true
          platform: ${{ matrix.platform }}

      # ========================================================================
      # Run tests
      # ========================================================================
      
      - name: Run tests
        run: cmake --build ${{ steps.build.outputs.build-dir }} --target run_tests

      # ========================================================================
      # Run python tests
      # ========================================================================
 
      - name: Install python requirements
        shell: bash
        run: |
          # Install the correct torch first.
          cuda_no_dot=$(echo ${{ matrix.cuda_version }} | sed 's/\.//')
          pip install torch==2.9.0 --index-url https://download.pytorch.org/whl/cu${cuda_no_dot}
          pip install numpy pytest onnxscript cupy-cuda${{ steps.config.outputs.cuda_major }}x cuquantum-cu${{ steps.config.outputs.cuda_major }} quimb opt_einsum nvidia-cublas cuquantum-python-cu${{ steps.config.outputs.cuda_major }}==25.09.1
          # The following tests are needed for docs/sphinx/examples/qec/python/tensor_network_decoder.py.
          if [ "$(uname -m)" == "x86_64" ]; then
              # Stim is not currently available on manylinux ARM wheels, so only
              # install for x86_64.
              pip install stim beliefmatching
          fi

      - name: Run Python tests
        run: cmake --build ${{ steps.build.outputs.build-dir }} --target run_python_tests

      # ========================================================================
      # Run example tests
      # ========================================================================

      - name: Run example tests
        run: bash scripts/ci/test_examples.sh qec

      # ========================================================================
      # Upload build artifacts for GPU tests
      # ========================================================================
      - name: Create artifact archive
        run: |
          tar czf /tmp/qec-build-artifacts.tar.gz \
            /cudaq-install \
            /tmp/cudaq-realtime \
            $GITHUB_WORKSPACE/libs/qec/unittests/decoders/realtime/data \
            $GITHUB_WORKSPACE/${{ steps.build.outputs.build-dir }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qec-build-${{ matrix.platform }}-cu${{ matrix.cuda_version }}
          path: /tmp/qec-build-artifacts.tar.gz
          retention-days: 1

  # ==========================================================================
  # GPU Tests - Run on GPU runners (uses build artifacts from pr-build)
  # ==========================================================================
  pr-build-gpu:
    name: GPU tests
    needs: pr-build
    if: startsWith(github.ref, 'refs/heads/pull-request/')
    strategy:
      fail-fast: false
      matrix:
        platform: ['amd64', 'arm64']
        cuda_version: ['12.6', '13.0']
    runs-on: ${{ startsWith(github.repository, 'NVIDIA/cudaqx') && format('linux-{0}-gpu-a100-latest-1', matrix.platform) || 'ubuntu-latest' }}
    container:
      image: ghcr.io/nvidia/cuda-quantum-devcontainer:${{ matrix.platform }}-cu${{ matrix.cuda_version }}-gcc11-main
      env:
        NVIDIA_VISIBLE_DEVICES: ${{ env.NVIDIA_VISIBLE_DEVICES }}
    permissions:
      actions: read
      contents: read
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: qec-build-${{ matrix.platform }}-cu${{ matrix.cuda_version }}
          path: /tmp

      - name: Extract build artifacts
        run: |
          tar xzf /tmp/qec-build-artifacts.tar.gz -C /

      - name: Run GPU tests
        run: |
          cd $GITHUB_WORKSPACE/build_qec
          ctest --output-on-failure -R "GpuKernelsTest|test_realtime_decoding"

